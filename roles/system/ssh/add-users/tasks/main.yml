- name: ユーザーを追加する
  user:
    name: '{{ item.key }}'
  loop: "{{ lookup('dict', users) }}"

- name: 公開鍵を登録する
  authorized_key:
    user: '{{ item.key }}'
    key: '{{ item.value.authorized_key }}'
  loop: "{{ lookup('dict', users) }}"

- name: ユーザー「Ansible」を追加する
  user:
    name: ansible
    generate_ssh_key: yes

- name: ユーザー「Ansible」のssh_configファイルを配置する
  template:
    src: templates/config
    dest: /home/ansible/.ssh/config
    owner: ansible
    group: ansible
    mode: 0600

- name: ユーザー「Ansible」の公開鍵を登録する
  authorized_key:
    user: ansible
    state: present
    key: "{{ lookup('file', '/home/ansible/.ssh/id_rsa.pub') }}"
