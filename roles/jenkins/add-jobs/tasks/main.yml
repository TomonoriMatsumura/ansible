- name: 作業用ディレクトリを初期化する
  become: yes
  file:
    path: '{{ work_dir }}'
    state: absent

- name: 作業用ディレクトリを作成する
  become: yes
  file:
    path: '{{ work_dir }}'
    state: directory
    mode: 0755

#- name: Jenkinsが利用するSSHDポートを取得する
#  shell: curl -v http://localhost:8080/jenkins/login 2>&1 | grep SSH-Endpoint | cut -d':' -f3
#  args:
#    warn: false
#  register: JENKINS_SSHD_PORT
#
#- name: JenkinsへPluginをインストールする
#  shell: "sudo -u {{ jenkins_admin_user }}
#          ssh
#          -o StrictHostKeyChecking=no
#          -l {{ jenkins_admin_user }}
#          -p {{ JENKINS_SSHD_PORT.stdout }}
#          localhost
#          install-plugin job-dsl"
#
#- name: Jenkinsを再起動する
#  become: yes
#  service:
#    name: jenkins
#    state: restarted
#
#- name: Jenkinsが起動するまで待機する
#  wait_for:
#    timeout: 30
#
- name: Jobリストの定義ファイルを取得する
  become: yes
  git:
    repo: '{{ joblist_definition_file_url }}'
    dest: "{{ work_dir }}/joblist"
    version: '{{ joblist_repo_version }}'

- name: Jobリスト定義ファイルを動的にAnsibleの変数ファイルとして読み込む
  become: yes
  include_vars:
    dir: "{{ work_dir }}/joblist"
    extensions:
      - yaml 

- name: インストールするJobのリポジトリからJenkinsfileを取得する
  become: yes
  git:
    repo: '{{ item.value.url }}'
    dest: '{{ item.key }}'
    version: '{{ item.value.version }}'
  loop: "{{ lookup('dict', jenkins_joblists) }}"
#
#- name: 登録するJobのリストを作成する
#  become: yes
#  shell: "ls {{ item }}"
#  args:
#    chdir: '{{ work_dir }}'
#  register: JOB_LIST
#
#- name: ディレクトリへJob DLS用の定義ファイルを作成する
#  become: yes
#  shell: "create-seed-jobs.sh {{ item }}"
#  args:
#    chdir: '{{ work_dir }}'
#  with_items: JOB_LIST.stdout
#
#- name: JenkinsへJob登録用Jobを登録する
#  become: yes
#  shell:
#  with_times:
#
