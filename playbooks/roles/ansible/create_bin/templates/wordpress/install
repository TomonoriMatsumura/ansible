PROGNAME=$(basename $0)
VERSION="0.1"

usage() {
    echo "Usage: $PROGRAM [OPTIONS] FILE"
    echo "  This script is ~."
    echo
    echo "Options:"
    echo "  -h, --help"
    echo
    echo "  --version"
    echo
    echo "  --db_host ARGUMENT"
    echo "          WordPressが利用するRDBSMのデータベースホスト"
    echo
    echo "  --db_name ARGUMENT"
    echo "          WordPressが利用するRDBSMのデータベース名"
    echo
    echo "  --db_password ARGUMENT"
    echo "          WordPressが利用するRDBSMのデータベースパスワード"
    echo
    echo "  --db_prefix ARGUMENT"
    echo "          WordPressが利用するRDBSMのデータベーステーブルのプレフィックス"
    echo
    echo "  --db_user ARGUMENT"
    echo "          WordPressが利用するRDBSMのデータベースユーザー名"
    echo
    echo " --mariadb_root_password ARGUMENT"
    echo "          MariaDBのrootパスワード（MariaDBインストール時に利用）"
    echo
    echo "  --skip-tags ARGUMENT"
    echo "          指定したタグのついたロールをスキップして実行する。タグの指定はコンマで区切る。"
    echo "              例）bash someplaybook-bash --skip-tags "httpd_install,language_php70_install" "
    echo 
    echo "                  指定可能なタグ"
    echo "                      -httpd_install "
    echo "                      -langage_php70_install "
    echo "                      -rdb_mariadb_install "
    echo "                      -rdb_mariadib_create-database "
    echo "                      -wordpress_install "
    echo
    echo "  --tags ARGUMENT"
    echo "          指定したタグのついたロールのみ実行する。タグの指定はコンマで区切る。"
    echo "              例）bash someplaybook-bash --tags "httpd_install,language_php70_install" "
    echo 
    echo "                  指定可能なタグ"
    echo "                      -httpd_install "
    echo "                      -langage_php70_install "
    echo "                      -rdb_mariadb_install "
    echo "                      -rdb_mariadib_create-database "
    echo "                      -wordpress_install "
    echo
    echo "  --wp_admin_email ARGUMENT"
    echo "          WordPressのログインユーザーのメールアドレス"
    echo
    echo "  --wp_admin_email ARGUMENT"
    echo "          WordPressのログインユーザーのメールアドレス"
    echo
    echo "  --wp_admin_password ARGUMENT"
    echo "          WordPressのログインパスワード"
    echo
    echo "  --wp_admin_user ARGUMENT"
    echo "          WordPressのログインユーザー名"
    echo
    echo "  --wp_host ARGUMENT"
    echo "          http(s)://を含まない"
    echo "          例) http(s)://{wp_host}"
    echo
    echo "  --wp_httpd_conf ARGUMENT"
    echo "          「/etc/httpd/conf.d」へ配置するWordPressディレクトリで"
    echo "           .htaccessを有効にする設定ファイル名"
    echo "           例）「/etc/httpd/conf.d/wordpress.conf」のように配置される"
    echo
    echo "  --wp_install_dir ARGUMENT"
    echo "          /var/www/html/以降のディレクトリ"
    echo "          例) /var/www/html/{wp_install_dir}"
    echo
    echo "  --wp_title ARGUMENT"
    echo "          WordPressのサイトタイトル"
    echo
    exit 1
}

EXTRA_VARS=""
TAGS=

for OPT in "$@"
do
    case "$OPT" in
        '-h'|'--help' )
            usage
            exit 1
            ;;

        '--version' )
            echo $VERSION
            exit 1
            ;;

        '--db_host' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} db_host=$2"
            shift 1 
            ;;

        '--db_name' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} db_name=$2"
            shift 1
            ;;

        '--db_password' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} db_password=$2"
            shift 1
            ;;

        '--db_prefix' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} db_prefix=$2"
            shift 1
            ;;

        '--db_user' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} db_user=$2"
            shift 1
            ;;

        '--mariadb_root_password' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} mariadb_root_password=$2"
            shift 1
            ;;

        '--skip-tags' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi

            if [[ ! -z ${TAGS} ]]; then
                echo "PROGRAM: Only one of [--tags] and [--skip-tags] options should be used."
                exit 1
            fi

            TAGS="--skip-tags \"$2\""
            shift 1
            ;;

        '--tags' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi

            if [[ ! -z ${TAGS} ]]; then
                echo "PROGRAM: Only one of [--tags] and [--skip-tags] options should be used."
                exit 1
            fi

            TAGS="--tags \"$2\""
            shift 1
            ;;

        '--wp_admin_email' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_admin_email=$2"
            shift 1
            ;;

        '--wp_admin_password' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_admin_password=$2"
            shift 1
            ;;

        '--wp_admin_user' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_admin_user=$2"
            shift 1
            ;;

        '--wp_host' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_host=$2"
            shift 1
            ;;

        '--wp_httpd_conf' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_httpd_conf=$2"
            shift 1
            ;;

        '--wp_install_dir' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_install_dir=$2"
            shift 1
            ;;

        '--wp_title' )
            if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                echo "RPROGRAM: option requires an argument -- $1"
                exit 1
            fi
            EXTRA_VARS="${EXTRA_VARS} wp_title=$2"
            shift 1
            ;;

        '--'|'-' )
            shift 1
            param+=( "$@" )
            break
            ;;

        -*)
            echo "$PROGNAME: illegal option -- '$(echo $1 | sed 's/^-*//')'" 1>&2
            exit 1
            ;;

        *)
            if [[ ! -z "$1" ]] && [[ ! "$1" =~ ^-x ]]; then
                param+=( "$1" )
                shift 1
            fi
            ;;
    esac
done


export ANSIBLE_HOST_KEY_CHECKING=False

# ログファイルのパスを設定する
LOG_PATH="/home/ansible/ansible/bin/wordpress_install-{{ item.key }}.log"
rm -rf ${LOG_PATH}
export ANSIBLE_LOG_PATH=${LOG_PATH}

EXTRA_VARS_AND_TAGS=""

if [[ ! -z "${EXTRA_VARS}" ]]; then
    EXTRA_VARS_ARGS=`echo ${EXTRA_VARS} | sed -e 's/^<space>//'`
    EXTRA_VARS_AND_TAGS="--extra-vars \"${EXTRA_VARS_ARGS}\""
fi

if [[ ! -z "${TAGS}" ]]; then
    extra_vars_and_tags="${EXTRA_VARS_AND_TAGS} ${TAGS}"
fi

expect -c "

    set timeout -1

    spawn ansible-playbook {{ ansible_user_dir }}/ansible/playbooks/wordpress_install.yml -S --ask-su-pass -i "{{ item.key }}:{{ ssh_port }}," -u ansible --ask-vault-pass `echo ${extra_vars_and_tags}`

    expect "SU*"

    send -- \"r-J6ai+h35\n\"

    expect "Vault*password"

    send \"yuchan55\n\"

    expect "Enter*passphrase"

    send \"yuchan55\n\"

    expect eof
    exit
    "    

# SSH接続が失敗している場合はステータス「1」を返して終了する
if tail -n 1 ${LOG_PATH} | grep unreachable=1 ; then
    exit 1
fi

# 処理が失敗している場合はステータス「1」を返して終了する
if ! tail -n 1 ${LOG_PATH} | grep failed=0 ; then
    exit 1
fi
